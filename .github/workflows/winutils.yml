name: Build and Release winutils.exe for Spark

on:
  workflow_dispatch:
    inputs:
      spark_version:
        description: "Spark version (e.g. 3.5.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:

      - name: Setup Java 8 (required by Hadoop native build)
        uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.6

      # ------------------------------------------------------------
      # Install ms build
      # ------------------------------------------------------------
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      # ------------------------------------------------------------
      # Validate Spark tag exists and resolve Hadoop version
      # ------------------------------------------------------------
      - name: Resolve Hadoop version from Spark POM
        shell: bash
        run: |
          set -e

          SPARK_VERSION="${{ inputs.spark_version }}"
          SPARK_POM_URL="https://raw.githubusercontent.com/apache/spark/v${SPARK_VERSION}/pom.xml"

          echo "Fetching Spark POM: $SPARK_POM_URL"
          curl -f -L "$SPARK_POM_URL" -o spark-pom.xml

          HADOOP_VERSION=$(xmllint --xpath \
            "string(//*[local-name()='properties']/*[local-name()='hadoop.version']/text())" \
            spark-pom.xml)

          if [ -z "$HADOOP_VERSION" ]; then
            echo "Failed to resolve Hadoop version from Spark ${SPARK_VERSION}"
            exit 1
          fi

          echo "Resolved Hadoop version: $HADOOP_VERSION"
          echo "HADOOP_VERSION=$HADOOP_VERSION" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Download Hadoop source
      # ------------------------------------------------------------
      - name: Download Hadoop source
        shell: bash
        run: |
          set -e

          HADOOP_VERSION="${HADOOP_VERSION}"
          HADOOP_URL="https://archive.apache.org/dist/hadoop/common/hadoop-${HADOOP_VERSION}/hadoop-${HADOOP_VERSION}-src.tar.gz"

          echo "Downloading Hadoop source: $HADOOP_URL"
          curl -f -L -o hadoop-src.tar.gz "$HADOOP_URL"

          # Fail fast if we downloaded HTML or garbage
          file hadoop-src.tar.gz
          test "$(stat -c%s hadoop-src.tar.gz)" -gt 1000000

          tar -xzf hadoop-src.tar.gz

      # ------------------------------------------------------------
      # Build winutils.exe using msbuild on the winutils solution
      # ------------------------------------------------------------
      - name: Build winutils
        shell: cmd
        run: |
          cd hadoop-%HADOOP_VERSION%-src\hadoop-common-project\hadoop-common\src\main\winutils
          msbuild winutils.sln /nologo /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:ForcePlatformToolset=true /p:WindowsTargetPlatformVersion=10.0 /p:OutDir=bin\ /p:IntermediateOutputPath=\Winutils\ /p:WsceConfigDir="../etc/config" /p:WsceConfigFile="wsce-site.xml"
          
          
      - name: Build native
        shell: cmd
        run: |
          cd hadoop-%HADOOP_VERSION%-src\hadoop-common-project\hadoop-common\src\main\native
          msbuild native.sln /nologo /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:ForcePlatformToolset=true /p:WindowsTargetPlatformVersion=10.0 /p:OutDir=bin\ /p:IntermediateOutputPath=\native\



      # ------------------------------------------------------------
      # Prepare artifact and zip it
      # ------------------------------------------------------------
      - name: Prepare winutils artifact
        shell: powershell
        run: |
          $HADOOP_VERSION = $env:HADOOP_VERSION
          mkdir dist
          cp "hadoop-${HADOOP_VERSION}-src/hadoop-common-project/hadoop-common/src/main/winutils/x64/Release/*.exe" dist/
          cp "hadoop-${HADOOP_VERSION}-src/hadoop-common-project/hadoop-common/src/main/winutils/x64/Release/*.lib" dist/
          cp "hadoop-${HADOOP_VERSION}-src/hadoop-common-project/hadoop-common/src/main/native/x64/Release/*.dll" dist/
          Compress-Archive -Path dist/* -DestinationPath "winutils-${HADOOP_VERSION}.zip" -Force

      # ------------------------------------------------------------
      # Release handling (overwrite if exists)
      # ------------------------------------------------------------
      - name: Delete existing release (if any)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete winutils-${HADOOP_VERSION} --yes || true

      - name: Create GitHub release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create winutils-${HADOOP_VERSION} \
            winutils-${HADOOP_VERSION}.zip \
            --title "winutils for Spark ${{ inputs.spark_version }}" \
            --notes "winutils.exe built from Hadoop ${HADOOP_VERSION}, as required by Spark ${{ inputs.spark_version }}"
